---
title: "Lake Okeechobee Water Quality Update"
output: 
  html_document:
    toc: yes
    includes:
      after_body: footer2.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
## Libraries
#devtools::install_github("SwampThingPaul/AnalystHelper")
library(AnalystHelper);
library(plyr)
library(reshape)

# GIS libraries 
# library(rgdal)
# library(rgeos)
library(sf)
library(sp)
library(raster)

wd="C:/Julian_LaCie/_Github/LakeO_WQ"

paths=paste0(wd,c("/Plots/","/export/","/Data/","/GIS"))
# Folder.Maker(paths);#One and done. Creates folders in working directory.
plot.path=paths[1]
export.path=paths[2]
data.path=paths[3]
GIS.path=paths[4]
GIS.path.gen="C:/Julian_LaCie/_GISData"

# Helper variables
# nad83.pro=CRS("+init=epsg:4269")
# utm17=CRS("+init=epsg:26917")
nad83.pro=st_crs("EPSG:4269")
utm17=st_crs("EPSG:26917")

# leg.fun=function(b,pal,leg.title,
#                  top.val=0.8,bot.val=0.2,mid.v.val=NULL,
#                  x.max=0.3,x.min=0.1,mid.val=NULL,
#                  txt.offset.val=-0.01,txt.y=NULL,leg.txt=NULL,
#                  txt.cex=0.75,txt.adj=0,txt.pos=4,txt.offset=0.5,
#                  title.cex=0.8,title.pos=3,title.adj=0,
#                  title.x=NULL,title.y=NULL,
#                  leg.type=c("continuous","categorical"), ...){
#   l.b=length(b)
#   labs=c(paste0("< ",b[2]),paste(b[2:(l.b-2)],b[3:(l.b-1)],sep=" - "),paste(paste0(">",b[(l.b-1)])))
#   n.bks=length(b)-1
#   mid.v.val=if(is.null(mid.v.val)==T){bot.val+(top.val-bot.val)/2}else{mid.v.val}
#   
#   mid.val=if(is.null(mid.val)==T){x.min+(x.max-x.min)/2}else{mid.val}
#   if(leg.type=="continuous"){
#     legend_image=as.raster(matrix(rev(pal),ncol=1))
#     rasterImage(legend_image,x.min,bot.val,x.max,top.val)
#     txt.y=if(is.null(txt.y)==T){c(bot.val,top.val)}else(txt.y)
#     leg.txt=if(is.null(leg.txt)==T){format(c(min(b),max(b)))}else(leg.txt)
#     text(x=x.max, y = txt.y, labels =leg.txt,cex=txt.cex,adj=txt.adj,pos=txt.pos,offset=txt.offset, ...)
#   }
#   if(leg.type=="categorical"){
#     bx.val= seq(bot.val,top.val,(top.val-bot.val)/n.bks)
#     rect(x.min,bx.val[1:n.bks],x.max,bx.val[2:(n.bks+1)],col=rev(pal),lty=0)
#     leg.txt=if(is.null(leg.txt)==T){labs}else(leg.txt)
#     text(y=bx.val[2:(n.bks+1)]-c(mean(diff(bx.val[2:(n.bks+1)]))/2), x = x.max, 
#          labels = rev(leg.txt),cex=txt.cex,xpd=NA,pos=txt.pos,adj=txt.adj)
#   }
#   
#   title.x=if(is.null(title.x)==T){mid.val}else{title.x}
#   title.y=if(is.null(title.y)==T){top.val}else{title.y}
#   text(x=title.x,y=title.y,leg.title,adj=title.adj,cex=title.cex,pos=title.pos,xpd=NA)
# }

st_text <- function(x, ...) {
  # from https://github.com/mdsumner/basf
  xy <- sf::st_coordinates(sf::st_centroid(x))[,1:2, drop = FALSE]
  args <- list(x = xy[,1, drop = TRUE], y = xy[,2, drop = TRUE], ...)
  ## just get lab, label, labels ...
  label <- args$lab
  if (is.null(label)) label <- sf::st_set_geometry(x, NULL)[[1L]]
  if (is.null(label)) label <- 1:nrow(xy)
  args$labels <- label
  args[["label"]] <- NULL  ## common aliases
  args[["lab"]] <- NULL
  do.call(raster::text, args)
}

# GIS Data ----------------------------------------------------------------
# lakeO=readOGR(paste0(wd,"/currentWQStatus/GIS"),"LakeO")
# lakeO=readOGR("./GIS","LakeO")
lakeO=st_read(paste0(wd,"/currentWQStatus/GIS"),"LakeO")
lakeO=st_read("./GIS","LakeO")

# wq.mon=readOGR(paste0(wd,"/currentWQStatus/GIS"),"WQmonitoring")
# wq.mon=readOGR("./GIS","WQmonitoring")
wq.mon=st_read(paste0(wd,"/currentWQStatus/GIS"),"WQmonitoring")
wq.mon=st_read("./GIS","WQmonitoring")

# lakeO.lit=readOGR(paste0(wd,"/currentWQStatus/GIS"),"LakeOLittoral")
# lakeO.lit=readOGR("./GIS","LakeOLittoral")
lakeO.lit=st_read(paste0(wd,"/currentWQStatus/GIS"),"LakeOLittoral")
lakeO.lit=st_read("./GIS","LakeOLittoral")

# canals=readOGR(paste0(wd,"/currentWQStatus/GIS"),"crop_canals")
# canals=readOGR("./GIS","crop_canals")
canals=st_read(paste0(wd,"/currentWQStatus/GIS"),"crop_canals")
canals=st_read("./GIS","crop_canals")

# WQ Sites  ----------------------------------------------------------------
sites=c(paste0("L00",1:8),"LZ40","LZ30","KISSR0.0",
        "FEBOUT","FEBIN","PALMOUT","POLE3S","MBOXSOU","MH32000","MH24000",
        "MH16000","OISLAND","TIN13700","TIN16100","RITTAE2","LZ25A","LZ25","PELBAY3",
        "PELMID","LZ2",
        paste0("TREEN",c("IN","MID","OUT")),
        paste0("TREE",c("IN","MID","OUT")),
        paste0("PLN4",c("IN","MID","OUT")),
        paste0("PLN3",c("IN","MID","OUT")),
        paste0("PLN2",c("IN","MID","OUT")),
        paste0("PLN1",c("IN","MID","OUT")),
        "RITAEAST","RITAW3","RITAWEST","LZ25",
        "LZ15","LZ42N",
        paste0("CPT",c("IN","MID","OUT")),
        paste0("KBAR",c("IN","MID","OUT")),
        paste0("3RDPT",c("IN","MID","OUT")),
        paste0("TIN",c("IN","MID","OUT")),
        paste0("IP",c("IN","MID","OUT")),
        paste0("STAKE",c("IN","MID","OUT")),
        paste0("POLES",c("IN","MID","OUT")),
        "LZ2","NES135","NES191",'CLV10A',"EASTSHORE",
        "S308C","S77","S169","S236","S354","S352","S351","S135",
        "S191","S133","S127","S72","S71","C41H78","S131",
        "FECSR78","CULV5","CULV5A","S65E","S4","INDUSCAN","CULV10A")

site.zones=data.frame(
  SITE=c("STAKEMID", "STAKEIN", "TREEMID", "OISLAND", "3RDPTIN", "MH16000", 
         "TREEIN", "PLN3IN", "PLN3MID", "TIN13700", "STAKEOUT", "POLESMID", 
         "3RDPTOUT", "FEBIN", "PLN4MID", "TININ", "PLN1IN", "POLE3S", 
         "PELBAY3", "TINMID", "TIN16100", "MBOXSOU", "PLN2MID", "POLESOUT", 
         "PLN4OUT", "PLN2IN", "POLESIN", "KBARIN", "PLN3OUT", "IPIN", 
         "TREENOUT", "3RDPTMID", "PLN4IN", "PLN1OUT", "KBAROUT", "LZ25", 
         "TREENMID", "TREENIN", "RITAWEST", "MH32000", "LZ25A", "FEBOUT", 
         "RITAEAST", "IPMID", "PLN2OUT", "MH24000", "PLN1MID", "TREEOUT", 
         "RITTAE2", "PALMOUT", "TINOUT", "KBARMID", "KISSR0.0", "PELMID", 
         "L001", "L002", "L003", "L004", "L005", "L006", "L007", "L008", 
         "LZ40", "LZ30", "RITAW3", "LZ15",
         "LZ2","NES135","NES191",'CLV10A',"EASTSHORE",
         "CPTOUT","CPTMID","CPTIN","IPOUT","LZ42N"),
  zone=c("littoral", "littoral", "littoral", "littoral", "littoral", 
         "littoral", "littoral", "littoral", "littoral", "littoral", "nearshore", 
         "nearshore", "nearshore", "littoral", "nearshore", "nearshore", 
         "nearshore", "nearshore", "nearshore", "nearshore", "nearshore", 
         "littoral", "nearshore", "nearshore", "nearshore", "nearshore", 
         "nearshore", "nearshore", "nearshore", "nearshore", "nearshore", 
         "nearshore", "nearshore", "nearshore", "nearshore", "nearshore", 
         "nearshore", "nearshore", "nearshore", "littoral", "nearshore", 
         "nearshore", "nearshore", "nearshore", "nearshore", "littoral", 
         "nearshore", "nearshore", "nearshore", "nearshore", "nearshore", 
         "nearshore", "nearshore", "nearshore", "pelagic", "pelagic", 
         "pelagic", "pelagic", "nearshore", "pelagic", "pelagic", "pelagic", 
         "pelagic", "pelagic", "pelagic", "pelagic",
         "nearshore","nearshore","nearshore","nearshore","nearshore",
         "nearshore","nearshore","nearshore","nearshore","nearshore")
)


site.zones.struct=data.frame(SITE=c("S308C","S77","S169","S236","S354","S352","S351",
                                    "S135","S191","S133","S127","S72","S71",
                                    "C41H78","S131","FECSR78","CULV5","CULV5A","S65E","S4","INDUSCAN","CULV10A"),
                             zone=NA)
site.zones=rbind(site.zones,site.zones.struct)
## WQ Data -------------------------------------------------
# -------------------------------------------------------------------------
end.date= date.fun(as.character(Sys.Date()))
end.date1=end.date
start.date=date.fun(end.date-lubridate::duration(4,"years"))
dates=c(start.date,end.date)

params=data.frame(Test.Number=c(21,20,18,80,61,179,25,23,16,12),
                  param=c("TKN","NH4","NOx","TN","Chla","Chla","TP","SRP","TSS","Turb"))

dat=data.frame()
for(i in 1:length(sites)){
  tmp=DBHYDRO_WQ(dates[1],dates[2],sites[i],params$Test.Number)
  dat=rbind(tmp,dat)
  print(i)
}
dat=merge(dat,params,"Test.Number")
dat=subset(dat,Collection.Method=="G")

dat.xtab=data.frame(cast(dat,Station.ID+Date.EST~param,value="HalfMDL",mean))

if(!(names(dat.xtab)%in%c("TKN"))){
  dat.xtab$TKN=NA
}
dat.xtab$TN=with(dat.xtab,TN_Combine(NOx,TKN,TN))
dat.xtab$DIN=with(dat.xtab,NH4+NOx)
dat.xtab$TP=dat.xtab$TP*1000;# convert to ug/L
dat.xtab$SRP=dat.xtab$SRP*1000;# convert to ug/L
dat.xtab$WY=WY(dat.xtab$Date.EST)
dat.xtab$season=FL.Hydroseason(dat.xtab$Date.EST)
dat.xtab$month=as.numeric(format(dat.xtab$Date.EST,"%m"))
dat.xtab$CY=as.numeric(format(dat.xtab$Date.EST,"%Y"))
dat.xtab$day=as.numeric(format(dat.xtab$Date.EST,"%d"))

sites.shp=cbind(data.frame(Station.ID=subset(wq.mon,STATION%in%sites)$STATION),
                st_coordinates(subset(wq.mon,STATION%in%sites)))
colnames(sites.shp)=c("Station.ID","UTMX","UTMY")
# sites.shp=SpatialPointsDataFrame(sites.shp[,c("UTMX","UTMY")],
#                                  sites.shp,
#                                  proj4string = utm17)
sites.shp=st_as_sf(sites.shp,coords=c("UTMX","UTMY"),crs=utm17)

dat.xtab=merge(dat.xtab,sites.shp,"Station.ID",all.x=T)
dat.xtab=merge(dat.xtab,site.zones,by.x="Station.ID",by.y="SITE")


SFWMD.SFER.analysis.sites=subset(site.zones,SITE%in%c(
  "CLV10A","KISSR0.0","L001","L004","L005","L006","L007","L008","LZ2",
  "LZ25A","LZ30","LZ40","PALMOUT","PELBAY3","POLE3S","POLESOUT","RITTAE2"
))

# subset(site.zones,)

subset(dat.xtab,zone=="littoral"&month==01&CY==2023)
dat.xtab.month.region=ddply(dat.xtab,c("CY","month","zone"),summarise,
                            mean.TP=mean(TP,na.rm=T),sd.TP=sd(TP,na.rm=T),N.TP=N.obs(TP),SE.TP=SE(TP),
                            mean.SRP=mean(SRP,na.rm=T),sd.SRP=sd(SRP,na.rm=T),N.SRP=N.obs(SRP),SE.SRP=SE(SRP),
                            mean.TN=mean(TN,na.rm=T),sd.TN=sd(TN,na.rm=T),N.TN=N.obs(TN),SE.TN=SE(TN),
                            mean.DIN=mean(DIN,na.rm=T),sd.DIN=sd(DIN,na.rm=T),N.DIN=N.obs(DIN),SE.DIN=SE(DIN),
                            mean.Chla=mean(Chla,na.rm=T),sd.Chla=sd(Chla,na.rm=T),N.DIN=N.obs(Chla),SE.Chla=SE(Chla))
zone.vals=c("littoral","nearshore","pelagic")
fill.val=expand.grid(CY=seq(2000,as.numeric(format(dates[2],"%Y")),1),
            month=1:12,
            zone=zone.vals)
dat.xtab.month.region=merge(dat.xtab.month.region,fill.val,c("CY","month","zone"),all.y=T)
dat.xtab.month.region$date.monCY=with(dat.xtab.month.region,date.fun(paste(CY,month,01,sep="-")))

```

Updated: `r paste(format(Sys.Date(),"%B %d, %Y"))`

***
<span style="color:red;">**Disclaimer:** The data provided here should be considered preliminary and are subject to change. The data used here is from the South Florida Water Management District and available on DBHYDRO. </span>

*This report is using data from DBHYDRO between `r format(dates[1],"%b %d, %Y")` and `r format(dates[2],"%b %d, %Y")`.*

***
## Spatial

```{r,echo=F,warning=FALSE,message=FALSE}
bks.TP=c(seq(0,500,100),3000)
cols.TP=viridis::plasma(length(bks.TP)-1,alpha = 0.75)
bks.TN=c(seq(0,3,1),20)
cols.TN=viridis::magma(length(bks.TN)-1,alpha = 0.75)

max.date=max(dat.xtab$Date.EST)
if(as.numeric(format(max.date,"%d"))<7){
  # adjusted for limited monthly data
  max.date=date.fun(paste(as.numeric(format(max.date,"%Y")),as.numeric(format(max.date,"%m"))-1,"01",sep="-"))
}

t1=date.fun(max.date-lubridate::duration(1,"month"))
t1.dat=subset(dat.xtab,month==as.numeric(format(t1,"%m"))&CY==as.numeric(format(t1,"%Y")))
t1.dat=ddply(t1.dat,c("Station.ID"),summarise,max.date=max(Date.EST),
      mean.TP=mean(TP,na.rm=T),N.TP=N.obs(TP),
      mean.TN=mean(TN,na.rm=T),N.TN=N.obs(TN))
# t1.dat=merge(t1.dat,
#              ddply(t1.dat,c("Station.ID"),summarise,max.date=max(Date.EST)),
#              by.x=c("Station.ID","Date.EST"),by.y=c("Station.ID","max.date"),all.y=T)
t1.dat.shp=merge(sites.shp,t1.dat,"Station.ID",all.x=T)
t1.dat.shp$TP.cols=col.vals=findInterval(t1.dat.shp$mean.TP,bks.TP)
t1.dat.shp.TP=subset(t1.dat.shp,is.na(TP.cols)==F)
t1.dat.shp.TP$mean.TP=round(t1.dat.shp.TP$mean.TP,0)

t1.dat.shp$TN.cols=col.vals=findInterval(t1.dat.shp$mean.TN,bks.TN)
t1.dat.shp.TN=subset(t1.dat.shp,is.na(TN.cols)==F)
t1.dat.shp.TN$mean.TN=round(t1.dat.shp.TN$mean.TN,2)

t2=max.date
t2.dat=subset(dat.xtab,month==as.numeric(format(t2,"%m"))&CY==as.numeric(format(t2,"%Y")))
t2.dat=ddply(t2.dat,c("Station.ID"),summarise,max.date=max(Date.EST),
      mean.TP=mean(TP,na.rm=T),N.TP=N.obs(TP),
      mean.TN=mean(TN,na.rm=T),N.TN=N.obs(TN))
# t2.dat=merge(t2.dat,
#              ddply(t2.dat,c("Station.ID"),summarise,max.date=max(Date.EST)),
#              by.x=c("Station.ID","Date.EST"),by.y=c("Station.ID","max.date"),all.y=T)
t2.dat.shp=merge(sites.shp,t2.dat,"Station.ID")
t2.dat.shp$TP.cols=col.vals=findInterval(t2.dat.shp$mean.TP,bks.TP)
t2.dat.shp.TP=subset(t2.dat.shp,is.na(TP.cols)==F)
t2.dat.shp.TP$mean.TP=round(t2.dat.shp.TP$mean.TP,0)

t2.dat.shp$TN.cols=col.vals=findInterval(t2.dat.shp$mean.TN,bks.TN)
t2.dat.shp.TN=subset(t2.dat.shp,is.na(TN.cols)==F)
t2.dat.shp.TN$mean.TN=round(t2.dat.shp.TN$mean.TN,2)

```


### Total Phosphorus

```{r TPMap,echo=F,warning=FALSE,message=FALSE,fig.width=6.5,fig.height=4,fig.align='center',fig.cap="Total Phosphorus concentrations across the lake for the last two months from grab samples only. If monitoring locations had more than one sample during the period (i.e. structures) average values were calculated."}

# png(filename=paste0(plot.path,"/LOK_TP.png"),width=6.5,height=4,units="in",res=200,type="windows",bg="white")
par(family="serif",mar=c(0.1,0.4,0.1,0.4),oma=c(0.2,0.2,0.5,0.2),xpd=F)
layout(matrix(1:3,1,3,byrow=T),widths=c(1,0.4,1))
bbox.lims=st_bbox(lakeO)

plot(st_geometry(lakeO),border="grey",
     ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=1)
plot(st_geometry(lakeO.lit),add=T,col=adjustcolor("grey50",0.5),border="grey")
plot(st_geometry(canals),add=T,col="lightblue")
plot(st_geometry(t1.dat.shp.TP),pch=21,bg=cols.TP[t1.dat.shp.TP$TP.cols],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(lakeO),border="black",add=T)
# raster::text(t1.dat.shp.TP,"mean.TP",pos=4,offset=0.5,halo=T,xpd=NA)
st_text(t1.dat.shp.TP,label=t1.dat.shp.TP$mean.TP,pos=4,offset=0.5,xpd=NA)
mtext(side=3,adj=0,line=-1.25,
      paste(min(format(t1.dat$max.date,"%b %d")),max(format(t1.dat$max.date,"%b %d, %Y")),sep=" - "))

plot(0:1,0:1,ann=F,axes=F,type="n")
leg.fun(bks.TP,cols.TP,"Total Phosphorus (\u03BCg L\u207B\u00B9)",
        leg.type = "categorical",
        txt.cex=1,title.cex = 1.25)

plot(st_geometry(lakeO),border="grey",
     ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=1)
plot(st_geometry(lakeO.lit),add=T,col=adjustcolor("grey50",0.5),border="grey")
plot(st_geometry(canals),add=T,col="lightblue")
plot(st_geometry(t2.dat.shp.TP),pch=21,bg=cols.TP[t2.dat.shp.TP$TP.cols],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(lakeO),border="black",add=T)
# raster::text(t1.dat.shp.TP,"mean.TP",pos=4,offset=0.5,halo=T,xpd=NA)
st_text(t2.dat.shp.TP,label=t2.dat.shp.TP$mean.TP,pos=4,offset=0.5,xpd=NA)
mtext(side=3,adj=0,line=-1.25,
      paste(min(format(t2.dat$max.date,"%b %d")),max(format(t2.dat$max.date,"%b %d, %Y")),sep=" - "))
mapmisc::scaleBar(crs=lakeO,"bottomleft",bty="n",cex=1,seg.len=4,outer=F,col="black");

```

### Total Nitrogen
```{r TNMap,echo=F,warning=FALSE,message=FALSE,fig.width=6.5,fig.height=4,fig.align='center',fig.cap="Total Nitrogen concentrations across the lake for the last two months from grab samples only. If monitoring locations had more than one sample during the period (i.e. structures) average values were calculated."}

par(family="serif",mar=c(0.1,0.4,0.1,0.4),oma=c(0.2,0.2,0.5,0.2),xpd=F)
layout(matrix(1:3,1,3,byrow=T),widths=c(1,0.4,1))

bbox.lims=st_bbox(lakeO)

plot(st_geometry(lakeO),border="grey",
     ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=1)
plot(st_geometry(lakeO.lit),add=T,col=adjustcolor("grey50",0.5),border="grey")
plot(st_geometry(canals),add=T,col="lightblue")
plot(st_geometry(t1.dat.shp.TN),pch=21,bg=cols.TN[t1.dat.shp.TN$TN.cols],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(lakeO),border="black",add=T)
st_text(t1.dat.shp.TN,label=t1.dat.shp.TN$mean.TN,pos=4,offset=0.5,xpd=NA)
mtext(side=3,adj=0,line=-1.25,
      paste(min(format(t1.dat$max.date,"%b %d")),max(format(t1.dat$max.date,"%b %d, %Y")),sep=" - "))

plot(0:1,0:1,ann=F,axes=F,type="n")
leg.fun(bks.TN,cols.TN,"Total Nitrogen (mg L\u207B\u00B9)",
        leg.type = "categorical",
        txt.cex=1,title.cex = 1.25)

plot(st_geometry(lakeO),border="grey",
     ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=1)
plot(st_geometry(lakeO.lit),add=T,col=adjustcolor("grey50",0.5),border="grey")
plot(st_geometry(canals),add=T,col="lightblue")
plot(st_geometry(t2.dat.shp.TN),pch=21,bg=cols.TN[t2.dat.shp.TN$TN.cols],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(lakeO),border="black",add=T)
st_text(t2.dat.shp.TN,label=t2.dat.shp.TN$mean.TN,pos=4,offset=0.5,xpd=NA)
mtext(side=3,adj=0,line=-1.25,
      paste(min(format(t2.dat$max.date,"%b %d")),max(format(t2.dat$max.date,"%b %d, %Y")),sep=" - "))
mapmisc::scaleBar(crs=lakeO,"bottomleft",bty="n",cex=0.75,seg.len=4,outer=F,col="black");
```


## Time Series 

```{r SiteMap,echo=F,warning=FALSE,message=FALSE,fig.width=6.5,fig.height=4,fig.align='center',fig.cap="Monitoring location with littoral, nearshore and pelagic/limnetic zones identified across Lake Okeechobee. Includes active and inactive (historical) monitoring locations."}

sites.shp2=merge(sites.shp,site.zones,by.x="Station.ID",by.y="SITE")
cols=wesanderson::wes_palette("Zissou1",3,"continuous")
zone.vals.labs=c("Littoral","Nearshore","Pelagic")
par(family="serif",mar=c(0.1,0.1,0.1,0.1),oma=c(0.5,0.5,0.5,0.5))
layout(matrix(1:2,1,2,byrow=T),widths=c(1,0.4))

plot(st_geometry(lakeO),border="grey",
     ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=1)
plot(st_geometry(lakeO.lit),add=T,col=adjustcolor("grey50",0.5),border="grey")
plot(st_geometry(canals),add=T,col="lightblue")
plot(st_geometry(lakeO),border="black",add=T)
plot(st_geometry(subset(sites.shp2,zone==zone.vals[3])),pch=21,bg=cols[3],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(subset(sites.shp2,zone==zone.vals[2])),pch=21,bg=cols[2],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(subset(sites.shp2,zone==zone.vals[1])),pch=21,bg=cols[1],add=T,cex=1.5,lwd=0.01)
plot(st_geometry(subset(sites.shp2,is.na(zone)==T)),pch=21,bg=NA,add=T,cex=1.5,lwd=0.01)
site1=subset(sites.shp2,Station.ID%in%c("S77","CULV5A","CULV5","FECSR78","S131","C41H78","S71","S72","S127","S65E"))
st_text(site1,label=site1$Station.ID,pos=2,cex=0.7,offset=0.4,xpd=NA)
site2=subset(sites.shp2,Station.ID%in%c("S4","S169","S236","S354","S351","INDUSCAN"))
st_text(site2,label=site2$Station.ID,pos=1,cex=0.7,offset=0.4,xpd=NA)
site3=subset(sites.shp2,Station.ID%in%c("S352","CULV10A","S308C","S135","S191"))
st_text(site3,label=site3$Station.ID,pos=4,cex=0.7,offset=0.4,xpd=NA)
site4=subset(sites.shp2,Station.ID%in%c("S133"))
st_text(site4,label=site4$Station.ID,pos=3,cex=0.7,offset=0.4,xpd=NA)

mapmisc::scaleBar(crs=lakeO,"bottomleft",bty="n",cex=0.75,seg.len=4,outer=F,col="black");

plot(0:1,0:1,ann=F,axes=F,type="n")
legend("center",legend=c(zone.vals.labs,"Structures"),
       lty=c(0),col=c("black"),
       pch=c(21),pt.bg=c(cols,NA),
       pt.cex=2,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=1)

# library(tmap)
# tmap_mode("view")
# tm_shape(sites.shp2)+tm_dots()

```

<br>

```{r monthlyTimeSeries,echo=FALSE,fig.width=7.5,fig.height=6,fig.align='center',fig.cap="Monthly arithmetic mean with standard error water quality parameters for littoral, nearshore and limnetic/pelagic regions of the lake."}
## Time Series Plot
edate=date.fun(paste(format(Sys.Date(),"%Y"),format(Sys.Date(),"%m"),"01",sep="-"))
sdate=date.fun(edate-lubridate::duration(18,"months"))
sdate=date.fun(paste(format(sdate,"%Y"),format(sdate,"%m"),"01",sep="-"))
cols=wesanderson::wes_palette("Zissou1",3,"continuous")
zone.vals.labs=c("Littoral","Nearshore","Pelagic")

layout(matrix(1:15,5,3,byrow=T))
par(family="serif",mar=c(1,1,0.25,0.5),oma=c(2,3,1,0.1),xpd=F);
xlim.val=c(sdate,edate);xmaj=seq(xlim.val[1],xlim.val[2],"6 months");xmin=seq(xlim.val[1],xlim.val[2],"1 months")

ylim.val=c(1,600);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor");# by.y=200;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(mean.TP~date.monCY,dat.xtab.month.region,ylim=ylim.val,xlim=xlim.val,ann=F,axes=F,type="n",log="y")  
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line_error(date.monCY,mean.TP,SE.TP,2,cols[i],1,21,cols[i],length=0.02,pt.lwd=0.01))
  #with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line(date.monCY,mean.TP,2,cols[i],1,21,cols[i]))
  # axis_fun(1,xmaj,xmin,NA)
  # axis_fun(1,xmaj,xmin,format(xmaj,"%m-%y"),line=-0.5)
  if(i==1){
    axis_fun(2,ymaj,ymin,ymaj);
    mtext(side=2,line=2.5,"TP (\u03BCg L\u207B\u00B9)")
    }else{
      axis_fun(2,ymaj,ymin,NA)
      }
  box(lwd=1)
  mtext(side=3,zone.vals.labs[i])
}
# ylim.val=c(0,600);by.y=200;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(mean.TP~date.monCY,dat.xtab.month.region,ylim=ylim.val,xlim=xlim.val,ann=F,axes=F,type="n",log="y")  
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line_error(date.monCY,mean.SRP,SE.SRP,2,cols[i],1,21,cols[i],length=0.02,pt.lwd=0.01))
  #with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line(date.monCY,mean.TP,2,cols[i],1,21,cols[i]))
  axis_fun(1,xmaj,xmin,NA)
  # axis_fun(1,xmaj,xmin,format(xmaj,"%m-%y"),line=-0.5)
  if(i==1){
    axis_fun(2,ymaj,ymin,ymaj);
    mtext(side=2,line=2.5,"SRP (\u03BCg L\u207B\u00B9)")
  }else{
    axis_fun(2,ymaj,ymin,NA)
  }
  box(lwd=1)
}

ylim.val=c(0,5);by.y=2;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(mean.TP~date.monCY,dat.xtab.month.region,ylim=ylim.val,xlim=xlim.val,ann=F,axes=F,type="n")  
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line_error(date.monCY,mean.TN,SE.TN,2,cols[i],1,21,cols[i],length=0.02,pt.lwd=0.01))
  #with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line(date.monCY,mean.TP,2,cols[i],1,21,cols[i]))
  axis_fun(1,xmaj,xmin,NA)
  # axis_fun(1,xmaj,xmin,format(xmaj,"%m-%y"),line=-0.5)
  if(i==1){
    axis_fun(2,ymaj,ymin,ymaj);
    mtext(side=2,line=2.5,"TN (mg L\u207B\u00B9)")
  }else{
    axis_fun(2,ymaj,ymin,NA)
  }
  box(lwd=1)
}
ylim.val=c(0,1);by.y=0.5;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(mean.TP~date.monCY,dat.xtab.month.region,ylim=ylim.val,xlim=xlim.val,ann=F,axes=F,type="n")  
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line_error(date.monCY,mean.DIN,SE.DIN,2,cols[i],1,21,cols[i],length=0.02,pt.lwd=0.01))
  #with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line(date.monCY,mean.TP,2,cols[i],1,21,cols[i]))
  axis_fun(1,xmaj,xmin,NA)
  # axis_fun(1,xmaj,xmin,format(xmaj,"%m-%y"),line=-0.5)
  if(i==1){
    axis_fun(2,ymaj,ymin,format(ymaj));
    mtext(side=2,line=2.5,"DIN (mg L\u207B\u00B9)")
  }else{
    axis_fun(2,ymaj,ymin,NA)
  }
  box(lwd=1)
}
ylim.val=c(1,300);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor");#by.y=100;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(mean.TP~date.monCY,dat.xtab.month.region,ylim=ylim.val,xlim=xlim.val,ann=F,axes=F,type="n",log="y")  
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line_error(date.monCY,mean.Chla,SE.Chla,2,cols[i],1,21,cols[i],length=0.02,pt.lwd=0.01))
  #with(subset(dat.xtab.month.region,zone==zone.vals[i]),pt_line(date.monCY,mean.TP,2,cols[i],1,21,cols[i]))
  # axis_fun(1,xmaj,xmin,NA)
  axis_fun(1,xmaj,xmin,format(xmaj,"%m-%y"),line=-0.5)
  if(i==1){
    axis_fun(2,ymaj,ymin,format(ymaj));
    mtext(side=2,line=2.5,"Chl-a (\u03BCg L\u207B\u00B9)")
  }else{
    axis_fun(2,ymaj,ymin,NA)
  }
  box(lwd=1)
  
}
mtext(side=1,outer=T,line=0.75,"Date (Month-Year)")


```


## Lake Okeechobee Loading
```{r data download and calculation, include = FALSE}
library(reshape2)
flow.dbkeys.E=data.frame(
  STRUCT=c("S308","S308"),
  ALIAS=c("S308","S308"),
  STATION=c("S308.DS","S308_S"),
  DBKEY=c("15626","DJ239"),
  Priority=c("P1","P2"),
  Basin="E",
  Inflow_direction=-1,
  Outflow=1,
  WQSite=c("S308C")
)

flow.dbkeys.W=data.frame(
  STRUCT=c("CU5A.S282","S77","S77"),
  ALIAS=c("CULV5A_C","S77_T","S77_T"),
  STATION=c("CULV5A_C","S77_T","S77_T"),
  DBKEY=c("90880","15635","DJ235"),
  Priority=c("P1","P1","P2"),
  Basin="W",
  Inflow_direction=-1,
  Outflow=1,
  WQSite=c("CULV5A","S77","S77")
)

flow.dbkeys.S=data.frame(
  STRUCT=c("CU10","CU10A","CU10A","CU12","CU12A","CU4A","INDUST","INDUST",
           "S2.S351","S2.S351","S236","S3.S354","S3.S354","S351_TEMP",
           "S352","S352","S352_TEMP","S354_TEMP","S4","S4","S2","S3"),
  ALIAS=c("C-10","CU10A","CU10A","C-12","C-12A","C-4A","INDUST","INDUST",
          "S2","S2","S236_P","S3","S3","S351_TEMP",
          "S352","S352","S352_TEMP","S354_TEMP","S4_P","S4_P","S2","S3"),
  STATION=c("C-10","L8.441","S271","C-12","C-12A","C-4A","INDUST","INDUST",
            "S2","S2","S236_P","S3","S3","S351_TEMP",
            "HGS5X","HGS5X","S352_TEMP","S354_TEMP","S4_P","S4_P","S2","S3"),
  DBKEY=c("15645","15640","65409","15646","15647","15648","15628","02747",
          "91508","15021","15644","91513","15018","91509",
          "15068","91510","91511","91514","15630","91608","91473","91599"),
  Priority=c("P1","P1","P2","P1","P1","P1","P1","P2",
             "P1","P2","P1","P1","P2","P1",
             "P1","P2","P1","P1","P1","P2","P1","P1"),
  Basin="S",
  Inflow_direction=c(1,-1,-1,1,1,1,-1,-1,
                     -1,-1,1,-1,-1,-1,
                     -1,-1,1,-1,1,1,1,-1),
  Outflow=c(0,1,1,0,0,0,1,1,
            1,1,0,1,1,1,
            1,1,1,1,0,0,1,1),
  WQSite=c("CULV10","CULV10A","CULV10A","CULV12","CULV12A","CULV4A","INDUSCAN","INDUSCAN",
           "S2","S2","S236","S3","S3","S351",
           "S352","S352","S352","S354","S4","S4","S2","S3")
)

flow.dbkeys.N=data.frame(
  STRUCT=c("C41","CU5.S281","FISHCR","G207","G208","G33",
           "G34","G74","G75","G76",
           "S127","S127","S127","S129","S129","S129",
           "S131","S131","S133","S133","S135","S135","S135",
           "S154","S154","S154C","S191","S191",
           "S65E","S65E","S65EX1","S71","S71",
           "S72","S72","S84","S84","S84X"),
  ALIAS=c("C41H78_I","CV5","FISHCR","G207","G208","G33_C",
          "G34_C","G74_C","G75_C","G76_C",
          "S127_C","S127_P","S127_P","S129_C","S129_P","S129_P",
          "S131_C","S131_P","S133_P","S133_P","S135_C","S135_P","S135_P",
          "S154_C","S154_C","S154C_C","S191_S","S191_S",
          "S65E_S","S65E_S","S65EX1_S","S71_S","S71_S",
          "S72_S","S72_S","S84_S","S84_S","S84X_S"),
  STATION=c("C41H78_I","CV5","FISHCR","G207","G208","G33_C",
            "G34_C","G74_C","G75_C","G76_C",
            "S127_C","S127_P","S127_P","S129_C","S129 PMP_P","S129 PMP_P",
            "S131_C","S131 PMP_P","S133_P","S133_P","S135_C","S135 PMP_P","S135 PMP_P",
            "S154_C","S154_C","S154C_C","S191_S","S191_S",
            "S65E_S","S65E_S","S65EX1_S","S71_S","S71_S",
            "S72_S","S72_S","S84_S","S84_S","S84X_S"),
  DBKEY=c(90871,90882,"WH036",90916,90918,91014,
          91071,91267,91268,91269,
          91370,15641,91371,91373,15642,91372,
          91376,15643,15637,91377,91379,15638,91378,
          15629,91401,91399,15639,91429,
          15631,91656,"AL760",15633,91668,
          15634,91675,15636,91687,91686),
  Priority=paste0("P",
                  c(1,1,1,1,1,1,
                    1,1,1,1,
                    1,1,2,1,1,2,
                    1,1,1,2,1,1,2,
                    1,2,1,1,2,
                    1,2,1,1,2,
                    1,2,1,2,1)),
  Basin="N",
  Inflow_direction=c(1,1,1,-1,-1,1,
                     1,1,1,1,
                     1,1,1,1,1,1,
                     1,1,1,1,1,1,1,
                     1,1,1,1,1,
                     1,1,1,1,1,
                     1,1,1,1,1),
  Outflow=c(0,1,0,1,1,0,
            0,0,0,0,
            1,0,0,1,0,0,
            1,0,0,0,1,0,0,
            0,0,0,0,0,
            0,0,0,0,0,
            0,0,0,0,0),
  WQSite=c("C41H78","CULV5","FECSR78","G207","G208","C38W",
           "L59E","L59W","L60E","L60W",
           "S127","S127","S127","S129","S129","S129",
           "S131","S131","S133","S133","S135","S135","S135",
           "S154","S154","S154C","S191","S191",
           "S65E","S65E","S65E","S71","S71",
           "S72","S72","S84","S84","S84")
)


flow.dbkeys=rbind(flow.dbkeys.N,flow.dbkeys.E,flow.dbkeys.S,flow.dbkeys.W)
paste(flow.dbkeys$DBKEY,collapse="/")

## Check metadata
DBHYDRO.meta.bysite=function(site,type,cat="SW"){
  # c("FLOW","STG","GATE")
  # cat = c("SW","RAIN","ETP")
  site.vals=paste0("v_site=",site)
  link=paste0("https://my.sfwmd.gov/dbhydroplsql/show_dbkey_info.show_dbkeys_matched?v_js_flag=Y&v_category=",cat,"&",
              site.vals,
              "&v_data_type=",type,
              "&v_dbkey_list_flag=Y&v_order_by=STATION")
  rslt.table=rvest::read_html(link)
  rslt.table=data.frame(rvest::html_table(rslt.table,fill=T)[[5]])
  rslt.table=rslt.table[,2:ncol(rslt.table)]
  colnames(rslt.table)=toupper(names(rslt.table))
  return(rslt.table)
  
}
# DBHYDRO.meta.bysite("S333","FLOW")

DBHYDRO.meta.byDBKEY=function(DBKEY){
  
  link=paste0("https://my.sfwmd.gov/dbhydroplsql/show_dbkey_info.show_dbkeys_matched?v_js_flag=Y&v_dbkey=",
              paste(DBKEY,collapse="/"),
              "&v_category=SW")
  rslt.table=rvest::read_html(link)
  rslt.table=data.frame(rvest::html_table(rslt.table,fill=T)[[5]])
  rslt.table=rslt.table[,2:ncol(rslt.table)]
  colnames(rslt.table)=toupper(names(rslt.table))
  return(rslt.table)
  
}
# DBHYDRO.meta.byDBKEY(flow.dbkeys$DBKEY)
#
# DBHYDRO.meta.link=paste0("https://my.sfwmd.gov/dbhydroplsql/show_dbkey_info.show_dbkeys_matched?v_js_flag=Y&v_dbkey=",
#                          paste(flow.dbkeys$DBKEY,collapse="/"),
#                          "&v_category=SW")
# flow.meta=read_html(DBHYDRO.meta.link)
# flow.meta=data.frame(html_table(flow.meta,fill=T)[[5]])

DBHYDRO.meta.byDBKEY(subset(flow.dbkeys,STRUCT=="S77")$DBKEY)

flow.meta=DBHYDRO.meta.byDBKEY(flow.dbkeys$DBKEY)
# head(flow.meta)
flow.meta$START.DATE=date.fun(flow.meta$START.DATE,form="%d-%B-%Y")
flow.meta$END.DATE=date.fun(flow.meta$END.DATE,form="%d-%B-%Y")

# max(flow.meta$END.DATE)
# min(flow.meta$END.DATE)
# subset(flow.meta,END.DATE<date.fun("2023-03-13"))

# subset(flow.meta,DBKEY=="WH036")
# DBHYDRO.meta.bysite("FISHCR","FLOW")
# -------------------------------------------------------------------------
# edate=date.fun(as.character(Sys.Date()))
# sdate=date.fun(paste(format(edate-lubridate::duration(4,"years"),"%Y"),"05-01",sep="-"))
# dates=c(sdate,edate)
# 
# subset(flow.meta,END.DATE%in%seq(sdate,edate,"1 day"))
# flow.dbkeys
# subset(flow.meta,SITE=="S77")
# subset(flow.meta,SITE=="S77"&START.DATE<dates[2]&END.DATE>dates[1])
# range(subset(flow.meta,START.DATE<dates[2]&END.DATE>dates[1])$END.DATE)
# subset(flow.dbkeys,DBKEY%in%subset(flow.meta,END.DATE%in%seq(sdate,date.fun(edate+lubridate::duration(1,"day")),"1 day"))$DBKEY)

flow.dbkeys2=subset(flow.dbkeys,DBKEY%in%subset(flow.meta,START.DATE<dates[2]&END.DATE>dates[1])$DBKEY)

## Just to check
# merge(ddply(flow.dbkeys,"STRUCT",summarise,N.val=N.obs(STRUCT)),
#       ddply(flow.dbkeys2,"STRUCT",summarise,N.val=N.obs(STRUCT)),"STRUCT",all.x=T)

flow.dat=data.frame()
for(i in 1:nrow(flow.dbkeys2)){
  tmp=DBHYDRO_daily(dates[1],dates[2],flow.dbkeys2$DBKEY[i])
  tmp$DBKEY=as.character(flow.dbkeys2$DBKEY[i])
  flow.dat=rbind(tmp,flow.dat)
  print(paste(i,": ",flow.dbkeys2$DBKEY[i]))
}


flow.data=merge(flow.dat,flow.dbkeys[,c("DBKEY","STRUCT","ALIAS","Priority","Basin","Inflow_direction","Outflow","WQSite")],"DBKEY")
flow.data$WY=WY(flow.data$Date)

flow.xtab=data.frame(reshape::cast(flow.data,Date+WY+STRUCT+ALIAS+Inflow_direction+Outflow+Basin+WQSite~Priority,value="Data.Value",fun.aggregate=function(x) ifelse(sum(x,na.rm=T)==0,NA,sum(x,na.rm=T))))
flow.xtab$Date.EST=date.fun(flow.xtab$Date)
flow.xtab$fflow.cfs=with(flow.xtab,ifelse(is.na(P1),P2,P1));#if only two priorities
flow.xtab$fflow.cfs=with(flow.xtab,fflow.cfs*Inflow_direction)#all inflows are positive and all negative values are outflow
flow.xtab$direct=with(flow.xtab,ifelse(fflow.cfs<0,"Outflow","Inflow"))
flow.xtab$month=as.numeric(format(flow.xtab$Date,"%m"))
flow.xtab$CY=as.numeric(format(flow.xtab$Date,"%Y"))

mon.seq=data.frame(Date.EST=date.fun(seq(dates[1],dates[2],"1 months")))
mon.seq$month=as.numeric(format(mon.seq$Date.EST,"%m"))
mon.seq$CY=as.numeric(format(mon.seq$Date.EST,"%Y"))
mon.seq$WY=WY(mon.seq$Date.EST)

# flow.mon.sum=reshape2::dcast(flow.xtab,STRUCT+ALIAS+Basin+WQSite+WY+CY+month~direct,value.var="fflow.cfs",fun.aggregate=function(x) sum(abs(cfs.to.acftd(x)),na.rm=T))
flow.mon.sum=reshape2::dcast(flow.xtab,STRUCT+ALIAS+Basin+WQSite+WY+CY+month~direct,value.var="fflow.cfs",fun.aggregate=function(x) sum(abs(x),na.rm=T))
flow.mon.sum=flow.mon.sum[,c("STRUCT", "ALIAS", "Basin", "WQSite", "WY", "CY", "month","Inflow", "Outflow")]


WY.Tflow=ddply(flow.mon.sum,"WY",summarise,inflow.Q.cfs=sum(Inflow,na.rm=T),outflow.Q.cfs=sum(Outflow,na.rm=T))
# WY.Tflow
# cfs.to.acftd(WY.Tflow$inflow.Q.cfs)
# cfs.to.acftd(WY.Tflow$outflow.Q.cfs)
# Water Quality -----------------------------------------------------------
wq.sites=ddply(flow.dbkeys2,"WQSite",summarise,N.val=N.obs(ALIAS))

wq.param=data.frame(Test.Number=c(16,18,20,21,23,25,80,89,100),
                    Param=c("TSS","NOx","NH4","TKN","OP","TP","TN","DOC","TOC"))
wq.param=subset(wq.param,!(Param%in%c("NH4","DOC","TOC","OP")))
wq.dat=data.frame()
for(i in 1:nrow(wq.sites)){
  tmp=DBHYDRO_WQ(dates[1],dates[2],wq.sites$WQSite[i],wq.param$Test.Number)
  wq.dat=rbind(tmp,wq.dat)
  print(paste0(i,": ",wq.sites$WQSite[i]))
}

wq.dat=merge(wq.dat,wq.param,"Test.Number")
unique(wq.dat$Collection.Method)
wq.dat=subset(wq.dat,Collection.Method=="G") # Grab sample only 
wq.dat$month=as.numeric(format(wq.dat$Date.EST,"%m"))
wq.dat$CY=as.numeric(format(wq.dat$Date.EST,"%Y"))
wq.dat$WY=WY(wq.dat$Date.EST)
N.TP=ddply(subset(wq.dat,Param=="TP"),c("WY","Station.ID"),summarise,N.val=N.obs(HalfMDL),mean.val=mean(HalfMDL,na.rm=T))
# N.TP
N.TSS=ddply(subset(wq.dat,Param=="TSS"),c("WY","Station.ID"),summarise,N.val=N.obs(HalfMDL),mean.val=mean(HalfMDL,na.rm=T))
# N.TSS

# checking for more than one sample per day
# test=cast(subset(wq.dat,Project.Code!="LAB"),Station.ID+Date.EST~Param,value="HalfMDL",fun.aggregate = function(x)N.obs(x))
# subset(test,TP>2)
# subset(wq.dat,Param=="TP"&Station.ID=="S65E"&Date.EST==date.fun("1990-06-18"))

# Daily mean WQ removing LAB project code.
wq.dat.xtab=reshape2::dcast(subset(wq.dat,Project.Code!="LAB"),Station.ID+Date.EST~Param,value.var="HalfMDL",mean,na.rm=T)
if(sum(names(wq.dat.xtab)%in%c("TKN"))==0){wq.dat.xtab$TKN=NA}
wq.dat.xtab$TN=with(wq.dat.xtab,TN_Combine(NOx,TKN,TN))
head(wq.dat.xtab)

ALIAS.vals=ddply(flow.dbkeys,"ALIAS",summarise,N.val=N.obs(DBKEY))
date.fill.frame=expand.grid(Date.EST=date.fun(seq(dates[1],dates[2],"1 days")),
                            ALIAS=ALIAS.vals$ALIAS)
flow.vars=c("STRUCT","ALIAS","WQSite","Basin","Date.EST","WY","direct","fflow.cfs")
wq.vars=c("Date.EST","Station.ID","TP","TN",'TSS')

flow.wq=merge(flow.xtab[,flow.vars],wq.dat.xtab[,wq.vars],by.x=c("Date.EST","WQSite"),by.y=c("Date.EST","Station.ID"),all.x=T)
head(flow.wq)
flow.wq=merge(date.fill.frame,flow.wq,c("Date.EST","ALIAS"),all.y=T)
flow.wq=flow.wq[order(flow.wq$ALIAS,flow.wq$Date.EST),]

# ddply(flow.wq,c("ALIAS","STRUCT",'WQSite'),summarise,N.val=N.obs(TP))
flow.wq$TP.int=with(flow.wq,ave(TP,ALIAS,FUN = function(x)dat.interp(x)))
flow.wq$TPLoad.kg=with(flow.wq,Load.Calc.kg(abs(fflow.cfs),TP.int))
flow.wq$TN.int=with(flow.wq,ave(TN,ALIAS,FUN = function(x)dat.interp(x)))
flow.wq$TNLoad.kg=with(flow.wq,Load.Calc.kg(abs(fflow.cfs),TN.int))
flow.wq$TSS.int=with(flow.wq,ave(TSS,ALIAS,FUN = function(x)dat.interp(x)))
flow.wq$TSSLoad.kg=with(flow.wq,Load.Calc.kg(abs(fflow.cfs),TSS.int))

flow.wq$month=as.numeric(format(flow.wq$Date.EST,"%m"))
flow.wq$CY=as.numeric(format(flow.wq$Date.EST,"%Y"))

TPload.mon.sum=reshape2::dcast(flow.wq,STRUCT+ALIAS+WQSite+Basin+WY+CY+month~direct,value.var="TPLoad.kg",fun.aggregate=function(x) sum(x,na.rm=T))
TPload.mon.sum=TPload.mon.sum[,c("STRUCT", "ALIAS","WQSite", "Basin", "WY", "CY", "month","Inflow", "Outflow")]

TNload.mon.sum=reshape2::dcast(flow.wq,STRUCT+ALIAS+WQSite+Basin+WY+CY+month~direct,value.var="TNLoad.kg",fun.aggregate=function(x) sum(x,na.rm=T))
TNload.mon.sum=TNload.mon.sum[,c("STRUCT", "ALIAS","WQSite", "Basin", "WY", "CY", "month","Inflow", "Outflow")]



# -------------------------------------------------------------------------
library(zoo)
Qload.mon.sum2=ddply(flow.mon.sum,c("WY","CY","month"),summarise,
                     inflow.flow=sum(Inflow,na.rm=T),
                     outflow.flow=sum(Outflow,na.rm=T))
Qload.mon.sum2$DOWY=with(Qload.mon.sum2,hydro.day(date.fun(paste(CY,month,"01",sep="-"))))
Qload.mon.sum2$cumInflow=with(Qload.mon.sum2,ave(inflow.flow,WY,FUN=function(x)cumsum(x)/1e3))
Qload.mon.sum2$cumOutflow=with(Qload.mon.sum2,ave(outflow.flow,WY,FUN=function(x)cumsum(x)/1e3))

TPload.mon.sum2=ddply(TPload.mon.sum,c("WY","CY","month"),summarise,
                      inflow.load=sum(Inflow,na.rm=T),
                      outflow.load=sum(Outflow,na.rm=T))
TPload.mon.sum2$DOWY=with(TPload.mon.sum2,hydro.day(date.fun(paste(CY,month,"01",sep="-"))))
TPload.mon.sum2$cumInflow=with(TPload.mon.sum2,ave(inflow.load,WY,FUN=function(x)cumsum(x)/1e3))
TPload.mon.sum2$cumOutflow=with(TPload.mon.sum2,ave(outflow.load,WY,FUN=function(x)cumsum(x)/1e3))

TPload.mon.sum2=merge(TPload.mon.sum2,Qload.mon.sum2[,c("CY","month","inflow.flow","outflow.flow")],c("CY","month"))
TPload.mon.sum2$inflow.FWM=with(TPload.mon.sum2,(inflow.load/(inflow.flow*1.233e6))*1e9)
TPload.mon.sum2$outflow.FWM=with(TPload.mon.sum2,(outflow.load/(outflow.flow*1.233e6))*1e9)
TPload.mon.sum2=TPload.mon.sum2[order(TPload.mon.sum2$CY,TPload.mon.sum2$month),]
TPload.mon.sum2$inflow.FWM.ma=with(TPload.mon.sum2,ifelse(inflow.flow==0,NA,rollapply(inflow.load,12,sum,align="right",fill=NA)/rollapply(inflow.flow*1.233e6,12,sum,align="right",fill=NA)*1e9))
TPload.mon.sum2$outflow.FWM.ma=with(TPload.mon.sum2,ifelse(outflow.flow==0,NA,rollapply(outflow.load,12,sum,align="right",fill=NA)/rollapply(outflow.flow*1.233e6,12,sum,align="right",fill=NA)*1e9))
TPload.mon.sum2$MonCY.date=with(TPload.mon.sum2,date.fun(paste(CY,month,"01",sep="-")))


TNload.mon.sum2=ddply(TNload.mon.sum,c("WY","CY","month"),summarise,
                      inflow.load=sum(Inflow,na.rm=T),
                      outflow.load=sum(Outflow,na.rm=T))
TNload.mon.sum2$DOWY=with(TNload.mon.sum2,hydro.day(date.fun(paste(CY,month,"01",sep="-"))))
TNload.mon.sum2$cumInflow=with(TNload.mon.sum2,ave(inflow.load,WY,FUN=function(x)cumsum(x)/1e3))
TNload.mon.sum2$cumOutflow=with(TNload.mon.sum2,ave(outflow.load,WY,FUN=function(x)cumsum(x)/1e3))

TNload.mon.sum2=merge(TNload.mon.sum2,Qload.mon.sum2[,c("CY","month","inflow.flow","outflow.flow")],c("CY","month"))
TNload.mon.sum2$inflow.FWM=with(TNload.mon.sum2,(inflow.load/(inflow.flow*1.233e6))*1e6)
TNload.mon.sum2$outflow.FWM=with(TNload.mon.sum2,(outflow.load/(outflow.flow*1.233e6))*1e6)
TNload.mon.sum2=TNload.mon.sum2[order(TNload.mon.sum2$CY,TNload.mon.sum2$month),]
TNload.mon.sum2$inflow.FWM.ma=with(TNload.mon.sum2,ifelse(inflow.flow==0,NA,rollapply(inflow.load,12,sum,align="right",fill=NA)/rollapply(inflow.flow*1.233e6,12,sum,align="right",fill=NA)*1e6))
TNload.mon.sum2$outflow.FWM.ma=with(TNload.mon.sum2,ifelse(outflow.flow==0,NA,rollapply(outflow.load,12,sum,align="right",fill=NA)/rollapply(outflow.flow*1.233e6,12,sum,align="right",fill=NA)*1e6))
TNload.mon.sum2$MonCY.date=with(TNload.mon.sum2,date.fun(paste(CY,month,"01",sep="-")))

```

### Cumulative Flow and Load 

```{r  monthlyCumQ,echo=FALSE,fig.width=6.5,fig.height=6,fig.align='center',fig.cap="Monthly cumulative discharge volume, total phosphorus (TP) and total nitrogen (TN) load (top, middle and bottom, respectively) for lake inflow (left) and outflow (right) for the last three water years."}
CurWY=WY(Sys.Date())
reg.vals.labs=c("Inflow","Outflow")
WY.vals=c(CurWY,CurWY-1,CurWY-2)
cols=rev(adjustcolor(wesanderson::wes_palette("Zissou1",3,"continuous"),0.5))
# png(filename=paste0(plot.path,"LakeO_cum.png"),width=6.5,height=6,units="in",res=200,type="windows",bg="white")
par(family="serif",mar=c(1,2,0.75,0.75),oma=c(2,3.5,1,0.1));
layout(matrix(1:6,3,2,byrow=T))
xlim.val=c(0,365);# by.x=90;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/3)
xlim.val2=as.Date(xlim.val,origin="2000-05-01");xmaj=seq(xlim.val2[1],xlim.val2[2],"3 months");xmin=hydro.day(seq(xlim.val2[1],xlim.val2[2],"1 months"))
xmaj.labs=format(xmaj,"%b");xmaj=hydro.day(xmaj)

ylim.val=c(0,1500);by.y=500;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(cumOutflow~DOWY,Qload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
for(j in 1:length(WY.vals)){
    with(subset(Qload.mon.sum2,WY==WY.vals[j]),pt_line(DOWY,cumInflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
}
axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=2,line=2.75,"Cumulative Discharge\nVolume (x1000 Ac-Ft)",cex=0.8)
mtext(side=3,reg.vals.labs[1],cex=0.8,font=2)
legend("topleft",
       legend=c(paste0(CurWY," - Incomplete Year"),CurWY-1,CurWY-2),
       pch=NA,pt.bg=NA,
       lty=c(1),lwd=2,col=cols,
       pt.cex=1.5,ncol=1,cex=0.75,bty="n",y.intersp=1.1,x.intersp=0.75,xpd=NA,xjust=0,yjust=1,
       title.adj = 0,title=" Water Year")

plot(cumOutflow~DOWY,Qload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
for(j in 1:length(WY.vals)){
  with(subset(Qload.mon.sum2,WY==WY.vals[j]),pt_line(DOWY,cumOutflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
}
axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=3,reg.vals.labs[2],cex=0.8,font=2)

ylim.val=c(0,560);by.y=100;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(cumOutflow~DOWY,TPload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
for(j in 1:length(WY.vals)){
  with(subset(TPload.mon.sum2,WY==WY.vals[j]),pt_line(DOWY,cumInflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
}
axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=2,line=2.75,"Cumulative TP\nLoad (tons)",cex=0.8)

plot(cumOutflow~DOWY,TPload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
for(j in 1:length(WY.vals)){
  with(subset(TPload.mon.sum2,WY==WY.vals[j]),pt_line(DOWY,cumOutflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
}
axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)

ylim.val=c(0,5600);by.y=1000;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(cumOutflow~DOWY,TNload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
for(j in 1:length(WY.vals)){
  with(subset(TNload.mon.sum2,WY==WY.vals[j]),pt_line(DOWY,cumInflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
}
axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=2,line=2.75,"Cumulative TN\nLoad (tons)",cex=0.8)

plot(cumOutflow~DOWY,TNload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
for(j in 1:length(WY.vals)){
  with(subset(TNload.mon.sum2,WY==WY.vals[j]),pt_line(DOWY,cumOutflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
}
axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=1,outer=T,"Day of Water Year",line=0.75)
```

### Flow-Weighted Mean Concentrations

```{r  monthlyTPFWM,echo=FALSE,fig.width=6.5,fig.height=5,fig.align='center',fig.cap="Monthly and 12-month moving average total phosphorus (TP) flow-weighted mean (FWM) concentration (Top) and total nitrogen (TN) FWM concentration (bottom) for lake inflow (left) and outflow (right) for the last three water years."}
CurWY=WY(Sys.Date())
cols=adjustcolor(c("dodgerblue1","indianred1"),0.5)
# png(filename=paste0(plot.path,"LakeO_FWM.png"),width=6.5,height=5,units="in",res=200,type="windows",bg="white")
par(family="serif",mar=c(1,2,1,0.75),oma=c(2,2,0.75,0.1));
layout(matrix(1:4,2,2,byrow=T))
xlim.val=date.fun(c(paste(CurWY-2,"05-01",sep="-"),paste(CurWY,"05-01",sep="-")));xmaj=seq(xlim.val[1],xlim.val[2],"1 years");xmin=seq(xlim.val[1],xlim.val[2],"6 months")

ylim.val=c(0,450);by.y=100;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(inflow.FWM~MonCY.date,TPload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
with(TPload.mon.sum2,pt_line(MonCY.date,inflow.FWM,1,cols[1],1.5,19,cols[1],pt.col=cols[1],cex=1.25))
lines(inflow.FWM.ma~MonCY.date,TPload.mon.sum2,lty=2,col=cols[1],lwd=1.5)
axis_fun(1,xmaj,xmin,WY(xmaj),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=2,line=2.5,"TP FWM (\u03BCg L\u207B\u00B9)")
mtext(side=3,"Inflow",font=2)
legend("topleft",
       legend=c("Monthly","12-month moving average"),
       pch=NA,pt.bg=NA,
       lty=c(1,2),lwd=2,col="grey",
       pt.cex=1.5,ncol=1,cex=0.75,bty="n",y.intersp=1.1,x.intersp=0.75,xpd=NA,xjust=0,yjust=1)

plot(inflow.FWM~MonCY.date,TPload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
with(TPload.mon.sum2,pt_line(MonCY.date,outflow.FWM,1,cols[1],1.5,19,cols[2],pt.col=cols[1],cex=1.25))
lines(outflow.FWM.ma~MonCY.date,TPload.mon.sum2,lty=2,col=cols[1],lwd=1.5)
axis_fun(1,xmaj,xmin,WY(xmaj),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=3,"Outflow",font=2)

ylim.val=c(0,10);by.y=2;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(inflow.FWM~MonCY.date,TNload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
with(TNload.mon.sum2,pt_line(MonCY.date,inflow.FWM,1,cols[2],1.5,19,cols[2],pt.col=cols[2],cex=1.25))
lines(inflow.FWM.ma~MonCY.date,TNload.mon.sum2,lty=2,col=cols[2],lwd=1.5)
axis_fun(1,xmaj,xmin,WY(xmaj),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=2,line=2.5,"TN FWM (mg L\u207B\u00B9)")

plot(inflow.FWM~MonCY.date,TNload.mon.sum2,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
with(TNload.mon.sum2,pt_line(MonCY.date,outflow.FWM,1,cols[2],1.5,19,cols[2],pt.col=cols[2],cex=1.25))
lines(outflow.FWM.ma~MonCY.date,TNload.mon.sum2,lty=2,col=cols[2],lwd=1.5)
axis_fun(1,xmaj,xmin,WY(xmaj),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
mtext(side=1,outer=T,"Water Year",line=0.75)
```


## Regional Outflow
```{r regional calculation, include = FALSE}
out.region=data.frame(STRUCT=c("S2.S351","S3.S354","S352","CU10A","S3","S2","S351_TEMP","S352_TEMP","S354_TEMP",
                               "S77",
                               "S308"),
                      region=c(rep("south",9),
                               "west",
                               "east")
                      )
TPload.mon.sum=merge(TPload.mon.sum,out.region,"STRUCT",all.x=T)
TNload.mon.sum=merge(TNload.mon.sum,out.region,"STRUCT",all.x=T)
flow.mon.sum=merge(flow.mon.sum,out.region,"STRUCT",all.x=T)

## regional summary
Qload.mon.sum.region=ddply(subset(flow.mon.sum,is.na(region)==F),c("region","WY","CY","month"),summarise,
                     inflow.flow=sum(Inflow,na.rm=T),
                     outflow.flow=sum(Outflow,na.rm=T))
Qload.mon.sum.region$DOWY=with(Qload.mon.sum.region,hydro.day(date.fun(paste(CY,month,"01",sep="-"))))
Qload.mon.sum.region$cumOutflow=with(Qload.mon.sum.region,ave(outflow.flow,region,WY,FUN=function(x)cumsum(x)/1e3))

TPload.mon.sum.region=ddply(subset(TPload.mon.sum,is.na(region)==F),c("region","WY","CY","month"),summarise,
                      inflow.load=sum(Inflow,na.rm=T),
                      outflow.load=sum(Outflow,na.rm=T))
TPload.mon.sum.region$DOWY=with(TPload.mon.sum.region,hydro.day(date.fun(paste(CY,month,"01",sep="-"))))
TPload.mon.sum.region$cumOutflow=with(TPload.mon.sum.region,ave(outflow.load,region,WY,FUN=function(x)cumsum(x)/1e3))
TPload.mon.sum.region=merge(TPload.mon.sum.region,Qload.mon.sum.region[,c("region","WY","CY","month","inflow.flow","outflow.flow")],c("region","WY","CY","month"))
TPload.mon.sum.region$outflow.FWM=with(TPload.mon.sum.region,(outflow.load/(outflow.flow*1.233e6))*1e9)
TPload.mon.sum.region=TPload.mon.sum.region[order(TPload.mon.sum.region$region,TPload.mon.sum.region$CY,TPload.mon.sum.region$month),]
TPload.mon.sum.region$MonCY.date=with(TPload.mon.sum.region,date.fun(paste(CY,month,"01",sep="-")))
reg.vals=c("west","south","east")
TPload.mon.sum.region$outflow.FWM.ma=NA
for(i in 1:3){
  TPload.mon.sum.region[TPload.mon.sum.region$region==reg.vals[i],"outflow.FWM.ma"]=rollapply(TPload.mon.sum.region[TPload.mon.sum.region$region==reg.vals[i],"outflow.load"],12,sum,align="right",fill=NA)/rollapply(TPload.mon.sum.region[TPload.mon.sum.region$region==reg.vals[i],"outflow.flow"]*1.233e6,12,sum,align="right",fill=NA)*1e9
}


TNload.mon.sum.region=ddply(subset(TNload.mon.sum,is.na(region)==F),c("region","WY","CY","month"),summarise,
                            inflow.load=sum(Inflow,na.rm=T),
                            outflow.load=sum(Outflow,na.rm=T))
TNload.mon.sum.region$DOWY=with(TNload.mon.sum.region,hydro.day(date.fun(paste(CY,month,"01",sep="-"))))
TNload.mon.sum.region$cumOutflow=with(TNload.mon.sum.region,ave(outflow.load,region,WY,FUN=function(x)cumsum(x)/1e3))
TNload.mon.sum.region=merge(TNload.mon.sum.region,Qload.mon.sum.region[,c("region","WY","CY","month","inflow.flow","outflow.flow")],c("region","WY","CY","month"))
TNload.mon.sum.region$outflow.FWM=with(TNload.mon.sum.region,(outflow.load/(outflow.flow*1.233e6))*1e6)
TNload.mon.sum.region=TNload.mon.sum.region[order(TNload.mon.sum.region$region,TNload.mon.sum.region$CY,TNload.mon.sum.region$month),]
TNload.mon.sum.region$MonCY.date=with(TNload.mon.sum.region,date.fun(paste(CY,month,"01",sep="-")))
TNload.mon.sum.region$outflow.FWM.ma=NA
for(i in 1:3){
  TNload.mon.sum.region[TNload.mon.sum.region$region==reg.vals[i],"outflow.FWM.ma"]=rollapply(TNload.mon.sum.region[TNload.mon.sum.region$region==reg.vals[i],"outflow.load"],12,sum,align="right",fill=NA)/rollapply(TNload.mon.sum.region[TNload.mon.sum.region$region==reg.vals[i],"outflow.flow"]*1.233e6,12,sum,align="right",fill=NA)*1e6
}
```

```{r  monthlyregionalCumFlowLoad,echo=FALSE,fig.width=7.5,fig.height=6,fig.align='center',fig.cap="Monthly cumulative discharge volume, total phosphorus (TP) and total nitrogen (TN) load (top, middle and bottom, respectively) for the Caloosahatchee (S-77; left), EAA (middle) and St Lucie (S-308; right) for the last three water years. Current load calculations only uses grab samples at monitoring locations to estimate nutrient concentrations."}
CurWY=WY(Sys.Date())
reg.vals=c("west","south","east")
reg.vals.labs=c("West (S77)" ,"South (S351,S352,S354,C10A)","East (S308)")
WY.vals=c(CurWY,CurWY-1,CurWY-2)
cols=rev(adjustcolor(wesanderson::wes_palette("Zissou1",3,"continuous"),0.5))

# png(filename=paste0(plot.path,"LakeO_Regional_cum.png"),width=6.5,height=5,units="in",res=200,type="windows",bg="white")
par(family="serif",mar=c(1,2,0.75,0.75),oma=c(2,3.5,1,0.1));
layout(matrix(1:9,3,3,byrow=T))
xlim.val=c(0,365);# by.x=90;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/3)
xlim.val2=as.Date(xlim.val,origin="2000-05-01");xmaj=seq(xlim.val2[1],xlim.val2[2],"3 months");xmin=hydro.day(seq(xlim.val2[1],xlim.val2[2],"1 months"))
xmaj.labs=format(xmaj,"%b");xmaj=hydro.day(xmaj)

ylim.val=c(0,500);by.y=250;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(cumOutflow~DOWY,Qload.mon.sum.region,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  for(j in 1:length(WY.vals)){
    with(subset(Qload.mon.sum.region,region==reg.vals[i]&WY==WY.vals[j]),pt_line(DOWY,cumOutflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
  }
  axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
  axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  if(i==1){mtext(side=2,line=2.5,"Cumulative Discharge\nVolume (x1000 Ac-Ft)",cex=0.8)}
  mtext(side=3,adj=0,reg.vals.labs[i],cex=0.8)
  if(i==1){
    legend("topleft",
           legend=c(paste0(CurWY," - Incomplete Year"),CurWY-1,CurWY-2),
           pch=NA,pt.bg=NA,
           lty=c(1),lwd=2,col=cols,
           pt.cex=1.5,ncol=1,cex=0.75,bty="n",y.intersp=1.1,x.intersp=0.75,xpd=NA,xjust=0,yjust=1,
           title.adj = 0,title=" Water Year")
  }
}

ylim.val=c(0,110);by.y=50;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(cumOutflow~DOWY,TPload.mon.sum.region,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  for(j in 1:length(WY.vals)){
    with(subset(TPload.mon.sum.region,region==reg.vals[i]&WY==WY.vals[j]),pt_line(DOWY,cumOutflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
  }
  axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
  axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  if(i==1){mtext(side=2,line=2.5,"Cumulative TP\nLoad (tons)",cex=0.8)}
}

ylim.val=c(0,1500);by.y=500;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(cumOutflow~DOWY,TNload.mon.sum.region,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F)
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  for(j in 1:length(WY.vals)){
    with(subset(TNload.mon.sum.region,region==reg.vals[i]&WY==WY.vals[j]),pt_line(DOWY,cumOutflow,1,cols[j],2,19,cols[j],pt.col=cols[j],cex=1.25))
  }
  axis_fun(1,xmaj,xmin,xmaj.labs,line=-0.5)
  axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  if(i==1){mtext(side=2,line=2.5,"Cumulative TN\nLoad (tons)",cex=0.8)}
  # mtext(side=3,adj=0,reg.vals.labs[i])
}
mtext(side=1,outer=T,"Day of Water Year",line=0.75)

```

```{r  monthlyregionalFWM,echo=FALSE,fig.width=6.5,fig.height=5,fig.align='center',fig.cap="Monthly and 12-month moving average total phosphorus (TP) flow-weighted mean (FWM) concentration (Top) and total nitrogen (TN) FWM concentration (bottom) for the Caloosahatchee (S-77; left), EAA (middle) and St Lucie (S-308; right) for the last three water years. Current load calculations only uses grab samples at monitoring locations to estimate nutrient concentrations."}
pal1=colorRampPalette(c("#ffb400", "#d2980d", "#a57c1b", "#786028", "#363445", "#48446e", "#5e569b", "#776bcd", "#9080ff"))
reg.vals=c("west","south","east")
reg.vals.labs=c("West (S77)" ,"South (S351,S352,S354,C10A)","East (S308)")

cols=adjustcolor(pal1(3),0.5)
# png(filename=paste0(plot.path,"LakeO_Regional_FWM.png"),width=6.5,height=5,units="in",res=200,type="windows",bg="white")
par(family="serif",mar=c(1,2,1,0.75),oma=c(2,3.5,1,0.1));
layout(matrix(1:6,2,3,byrow=T))
xlim.val=date.fun(c(paste(CurWY-2,"05-01",sep="-"),paste(CurWY,"05-01",sep="-")));xmaj=seq(xlim.val[1],xlim.val[2],"1 years");xmin=seq(xlim.val[1],xlim.val[2],"6 months")

ylim.val=c(100,1000);ymaj=c(log.scale.fun(ylim.val,"major"),500);ymin=log.scale.fun(ylim.val,"minor")# by.y=250;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
plot(outflow.FWM~MonCY.date,TPload.mon.sum.region,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F,log="y")
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
with(subset(TPload.mon.sum.region,region==reg.vals[i]),pt_line(MonCY.date,outflow.FWM,1,cols[i],1.5,19,cols[i],pt.col=cols[i],cex=1.25))
lines(outflow.FWM.ma~MonCY.date,subset(TPload.mon.sum.region,region==reg.vals[i]),lty=2,col=cols[i],lwd=1.5)
axis_fun(1,xmaj,xmin,WY(xmaj),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
if(i==1){mtext(side=2,line=2.75,"TP FWM (\u03BCg L\u207B\u00B9)")}
mtext(side=3,adj=0,reg.vals.labs[i],cex=0.8)
if(i==1){legend("topleft",
       legend=c("Monthly","12-month moving average"),
       pch=NA,pt.bg=NA,
       lty=c(1,2),lwd=2,col="grey",
       pt.cex=1.5,ncol=1,cex=0.75,bty="n",y.intersp=1.1,x.intersp=0.75,xpd=NA,xjust=0,yjust=1)
}
}

ylim.val=c(1,10);ymaj=c(log.scale.fun(ylim.val,"major"),500);ymin=log.scale.fun(ylim.val,"minor")# by.y=250;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
  plot(outflow.FWM~MonCY.date,TNload.mon.sum.region,type="n",xlim=xlim.val,ylim=ylim.val,ann=F,axes=F,log="y")
  abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.5)
  with(subset(TNload.mon.sum.region,region==reg.vals[i]),pt_line(MonCY.date,outflow.FWM,1,cols[i],1.5,19,cols[i],pt.col=cols[i],cex=1.25))
  lines(outflow.FWM.ma~MonCY.date,subset(TNload.mon.sum.region,region==reg.vals[i]),lty=2,col=cols[i],lwd=1.5)
  axis_fun(1,xmaj,xmin,WY(xmaj),line=-0.5)
  axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  if(i==1){mtext(side=2,line=2.75,"TN FWM (mg L\u207B\u00B9)")}

}
mtext(side=1,outer=T,"Water Year",line=0.75)
```